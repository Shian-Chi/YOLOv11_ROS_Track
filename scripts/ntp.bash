#!/bin/bash
# === 自訂：將 sudo 指令封裝成變數，方便重複呼叫 ===
SUDO='echo "123456789" | sudo -S'

# 1) 確保 NTP 已安裝 ----------------------------------------------------------
echo "檢查 NTP 是否已安裝..."
if ! command -v ntpq &> /dev/null; then
    echo "NTP 未安裝，正在安裝..."
    $SUDO apt update
    $SUDO apt install -y ntp
else
    echo "NTP 已安裝"
fi

# 2) 啟動並啟用 NTP 服務 ------------------------------------------------------
echo "啟動 NTP 服務..."
$SUDO systemctl enable ntp
$SUDO systemctl restart ntp

# 3) 等待服務啟動 -------------------------------------------------------------
sleep 5

# 4) 顯示當前同步狀態 ---------------------------------------------------------
echo "NTP 伺服器同步狀態："
ntpq -p

# 5) 強制與台灣標準時間伺服器同步 --------------------------------------------
NTP_SERVER="time.stdtime.gov.tw"
echo "正在與 $NTP_SERVER 進行時間同步..."
$SUDO ntpdate -u "$NTP_SERVER"

# 6) 顯示同步後的系統時間 -----------------------------------------------------
echo "同步後的系統時間："
date +"%Y-%m-%d %H:%M:%S %Z"

# 7) 把系統時間寫入硬體時鐘 ----------------------------------------------------
echo "更新硬體時鐘..."
$SUDO hwclock --systohc

# 8) 完成 ---------------------------------------------------------------------
echo "系統時間已成功同步並更新到硬體時鐘。"